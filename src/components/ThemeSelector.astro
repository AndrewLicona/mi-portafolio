---
import Icon from "./Icon.astro";
---

<div class="relative">
  <!-- Botón principal -->
  <button 
    id="theme-dropdown-btn"
    class="flex items-center gap-2 px-4 py-2 rounded-lg bg-base-light hover:bg-base-dark transition-all text-text-base"
    aria-label="Seleccionar tema"
    onclick="document.getElementById('theme-dropdown').classList.toggle('hidden')"
  >
    <Icon name="palette" class="w-5 h-5" />
    <span class="text-sm font-medium hidden sm:inline">Tema</span>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
    </svg>
  </button>

  <!-- Dropdown -->
  <div 
    id="theme-dropdown"
    class="hidden absolute right-0 mt-2 w-64 border border-base-dark rounded-lg shadow-xl p-4 z-50"
    style="background-color: var(--color-base-light);"
  >
    <!-- Dark/Light Mode Toggle -->
    <div class="mb-4 pb-4 border-b border-base-dark">
      <p class="text-xs text-text-muted mb-3 font-semibold uppercase">Modo</p>
      <button 
        id="theme-mode-toggle-dropdown"
        class="w-full flex items-center justify-between px-3 py-2 rounded-lg bg-base hover:bg-base-dark transition-all"
        onclick="toggleThemeMode()"
      >
        <div class="flex items-center gap-2">
          <Icon id="icon-sun-dropdown" name="sun" class="w-5 h-5 text-text-base hidden" />
          <Icon id="icon-moon-dropdown" name="moon" class="w-5 h-5 text-text-base" />
          <span id="mode-text" class="text-sm text-text-base">Oscuro</span>
        </div>
        <svg class="w-4 h-4 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12M8 12h12m-12 5h12"></path>
        </svg>
      </button>
    </div>

    <!-- Color Theme Selector -->
    <div>
      <p class="text-xs text-text-muted mb-3 font-semibold uppercase">Color de acento</p>
      <div class="grid grid-cols-2 gap-2">
        <button 
          data-theme="theme-blue"
          class="theme-option flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-base transition-all"
          onclick="changeTheme('theme-blue')"
        >
          <div class="w-6 h-6 rounded-full shrink-0" style="background-color: var(--color-accent-blue)"></div>
          <span class="text-sm text-text-base">Azul</span>
        </button>

        <button 
          data-theme="theme-purple"
          class="theme-option flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-base transition-all"
          onclick="changeTheme('theme-purple')"
        >
          <div class="w-6 h-6 rounded-full shrink-0" style="background-color: var(--color-accent-purple)"></div>
          <span class="text-sm text-text-base">Morado</span>
        </button>

        <button 
          data-theme="theme-green"
          class="theme-option flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-base transition-all"
          onclick="changeTheme('theme-green')"
        >
          <div class="w-6 h-6 rounded-full shrink-0" style="background-color: var(--color-accent-green)"></div>
          <span class="text-sm text-text-base">Verde</span>
        </button>

        <button 
          data-theme="theme-silver"
          class="theme-option flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-base transition-all"
          onclick="changeTheme('theme-silver')"
        >
          <div class="w-6 h-6 rounded-full shrink-0" style="background-color: var(--color-accent-silver)"></div>
          <span class="text-sm text-text-base">Plata</span>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Declaración de tipos para TypeScript
  declare global {
    interface Window {
      toggleThemeMode: () => void;
      changeTheme: (theme: string) => void;
    }
  }

  // Cargar tema guardado al inicio
  document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('colorTheme') || 'theme-blue';
    const savedMode = localStorage.getItem('themeMode') || 'dark';
    
    // Aplicar tema de color
    document.body.classList.add(savedTheme);
    
    // Aplicar modo claro/oscuro
    if (savedMode === 'light') {
      document.body.classList.add('light-mode');
      document.getElementById('icon-sun-dropdown')?.classList.remove('hidden');
      document.getElementById('icon-moon-dropdown')?.classList.add('hidden');
      const modeText = document.getElementById('mode-text');
      if (modeText) modeText.textContent = 'Claro';
    }
  });

  // Cerrar menú al hacer clic fuera
  document.addEventListener('click', (e) => {
    const dropdown = document.getElementById('theme-dropdown');
    const btn = document.getElementById('theme-dropdown-btn');
    const target = e.target as Node;
    
    if (dropdown && btn && !dropdown.contains(target) && !btn.contains(target)) {
      dropdown.classList.add('hidden');
    }
  });

  // Función para cambiar entre modo claro/oscuro
  window.toggleThemeMode = function() {
    const body = document.body;
    const isLightMode = body.classList.toggle('light-mode');
    
    // Actualizar iconos
    document.getElementById('icon-sun-dropdown')?.classList.toggle('hidden', !isLightMode);
    document.getElementById('icon-moon-dropdown')?.classList.toggle('hidden', isLightMode);
    
    // Actualizar texto
    const modeText = document.getElementById('mode-text');
    if (modeText) {
      modeText.textContent = isLightMode ? 'Claro' : 'Oscuro';
    }
    
    // Guardar preferencia
    localStorage.setItem('themeMode', isLightMode ? 'light' : 'dark');
  };

  // Función para cambiar el tema de color
  window.changeTheme = function(theme: string) {
    // Limpiar temas anteriores
    document.body.classList.remove('theme-blue', 'theme-purple', 'theme-green', 'theme-silver');
    
    // Aplicar nuevo tema
    document.body.classList.add(theme);
    
    // Guardar preferencia
    localStorage.setItem('colorTheme', theme);
    
    // Cerrar menú
    document.getElementById('theme-dropdown')?.classList.add('hidden');
  };
</script>
